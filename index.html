<!DOCTYPE html>
<html lang="zh" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é…’é¦†å›¾é‰´ Pro Max</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="é…’é¦†å›¾é‰´">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
    <style type="text/tailwindcss">

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .hide { display: none !important; }
        
        .glass-nav { @apply bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/50 dark:border-slate-700/50; }
                .glass-sidebar { @apply bg-white dark:bg-slate-900 shadow-[4px_0_24px_rgba(0,0,0,0.15)]; }

        
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label:after { transform: translateX(100%); border-color: white; }

        .sidebar-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-closed { transform: translateX(-100%); }
        
        .card-selected { border-color: #4f46e5 !important; border-width: 2px !important; transform: scale(0.96); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
        .card-selectable { cursor: pointer; }
        .card-selectable:hover { border-color: #818cf8; }

       
        .batch-bar { transform: translateX(-50%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s; }
        .batch-bar-hidden { transform: translate(-50%, 150%); opacity: 0; pointer-events: none; }

        /* Toast åŠ¨ç”» */
        .toast-enter { animation: toastIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .toast-leave { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen font-sans text-slate-800 dark:text-slate-200 transition-colors duration-300 flex flex-col overflow-x-hidden">
<header class="glass-nav sticky top-0 z-40">
        <div class="max-w-[1400px] mx-auto px-4 py-3 sm:px-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg md:hidden transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400 tracking-tight flex items-center gap-2">
                        ğŸ­ é…’é¦†å›¾é‰´
                    </h1>
                </div>
                
                <div class="flex items-center gap-2 md:hidden">
                    <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:text-indigo-500 dark:text-slate-400 dark:hover:text-amber-400 transition-colors">
                        <svg id="themeIconM" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                    <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                        <button onclick="switchTab('cards')" id="tab-cards-m" class="px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all">è§’è‰²</button>
                        <button onclick="switchTab('worldbooks')" id="tab-wb-m" class="px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 transition-all">ä¸–ç•Œ</button>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                <div class="hidden md:flex items-center gap-3">
                    <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:text-indigo-500 dark:text-slate-400 dark:hover:text-amber-400 transition-colors">
                        <svg id="themeIconPC" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                    </button>
                    <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg mr-2">
                        <button onclick="switchTab('cards')" id="tab-cards-pc" class="px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all">è§’è‰²å¡</button>
                        <button onclick="switchTab('worldbooks')" id="tab-wb-pc" class="px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-all">ä¸–ç•Œä¹¦</button>
                    </div>
                </div>

                <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="æœç´¢åç§°æˆ–è®¾å®š..." 
                    class="px-4 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-full focus:ring-2 focus:ring-indigo-500 outline-none flex-1 sm:flex-none sm:w-48 bg-white/50 dark:bg-slate-800/50 dark:text-white transition-all shadow-sm">
                
                <button onclick="openUploadModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full text-sm font-medium transition-all shadow-md active:scale-95 shrink-0">
                    + å½•å…¥
                </button>
            </div>
        </div>
    </header><div id="sidebarOverlay" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 z-40 hide backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>
    <aside id="sidebar" class="sidebar-drawer sidebar-closed fixed left-0 top-0 h-full w-72 md:w-80 glass-sidebar shadow-2xl z-50 p-6 overflow-y-auto flex flex-col border-r border-slate-200/50 dark:border-slate-700/50">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-sm font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                å…¨éƒ¨åˆ†ç±»
            </h3>
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 p-1.5 bg-slate-100 dark:bg-slate-800 rounded-full transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div id="categoryList" class="flex flex-wrap gap-2 mb-auto pb-6">
            </div>

        <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-3">
            <p class="text-xs text-slate-400 dark:text-slate-500 mb-2 font-medium">æ•°æ®ç®¡ç†</p>
            <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 dark:hover:bg-slate-600 text-white px-4 py-2.5 rounded-xl text-sm font-medium transition-all shadow-md">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                å¯¼å‡ºå…¨åº“å¤‡ä»½
            </button>
            <label class="w-full flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl text-sm font-medium transition-all shadow-md cursor-pointer">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importData(event)">å¯¼å…¥è¦†ç›–æ•°æ®
            </label>
        </div>
    </aside><main class="flex-1 w-full max-w-[1400px] mx-auto px-4 py-6 flex flex-col relative pb-24">
        <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-slate-200/60 dark:border-slate-700 mb-4 flex-wrap gap-2 transition-colors">
            <div class="flex items-center gap-3 px-2">
                <button onclick="toggleSidebar()" class="hidden md:flex items-center gap-1 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-indigo-400 bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg> åˆ†ç±»
                </button>
                <span id="cardCount" class="text-sm text-slate-500 dark:text-slate-400 font-medium">åŠ è½½ä¸­...</span>
            </div>
            
            <div class="flex items-center gap-4 pr-2">
                <label class="flex items-center gap-2 cursor-pointer">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300">æ‰¹é‡ç®¡ç†</span>
                    <input type="checkbox" id="batchToggle" class="hidden" onchange="toggleBatchMode()">
                    <div id="batchToggleUI" class="w-10 h-6 bg-slate-300 dark:bg-slate-600 rounded-full p-1 transition-colors duration-300">
                        <div class="w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-300"></div>
                    </div>
                </label>
                <div class="h-4 w-px bg-slate-300 dark:bg-slate-600"></div>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300">åˆ†é¡µ</span>
                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="viewToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 dark:border-slate-500 appearance-none cursor-pointer z-10" onclick="toggleViewMode()"/>
                        <label for="viewToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-600 cursor-pointer"></label>
                    </div>
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300 text-xs">å…¨æ˜¾</span>
                </div>
            </div>
        </div>

        <div id="cardGrid" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-5 mb-6">
            </div>
        
        <div id="emptyState" class="text-center py-24 hide bg-white dark:bg-slate-800 rounded-2xl border border-slate-200/60 dark:border-slate-700 transition-colors">
            <div class="text-5xl mb-4 opacity-50">ğŸ“­</div>
            <h3 class="text-slate-500 dark:text-slate-400 font-medium" id="emptyText">æ­¤åˆ†ç±»ä¸‹æš‚æ— å†…å®¹</h3>
        </div>

        <div id="paginationCtrl" class="flex justify-center items-center gap-2 mt-auto bg-white dark:bg-slate-800 p-2 rounded-2xl shadow-sm border border-slate-200/60 dark:border-slate-700 w-max mx-auto transition-colors">
            <button onclick="changePage(-1)" class="px-3 py-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors font-medium text-sm">ä¸Šä¸€é¡µ</button>
            <div class="flex items-center gap-2 px-2 border-x border-slate-200 dark:border-slate-600">
                <input type="number" id="pageInput" min="1" value="1" class="w-12 text-center py-1 bg-transparent border border-slate-300 dark:border-slate-600 rounded-md outline-none text-sm dark:text-white" onchange="jumpToPage()">
                <span class="text-sm text-slate-500 dark:text-slate-400">/ <span id="totalPages">1</span> é¡µ</span>
            </div>
            <button onclick="changePage(1)" class="px-3 py-1.5 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition-colors font-medium text-sm">ä¸‹ä¸€é¡µ</button>
        </div>
    </main><div id="batchActionBar" class="batch-bar batch-bar-hidden fixed bottom-6 left-1/2 bg-slate-900/95 dark:bg-slate-800/95 backdrop-blur-md text-white px-5 py-3 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.3)] z-40 flex items-center gap-3 border border-slate-700 dark:border-slate-600 whitespace-nowrap">
        <span class="text-sm font-medium mr-1">å·²é€‰ <span id="selectedCount" class="text-indigo-400 font-bold text-lg">0</span></span>
        <div class="w-px h-5 bg-slate-700 dark:bg-slate-600"></div>
        <button onclick="batchDownload()" class="bg-indigo-600 hover:bg-indigo-500 px-4 py-1.5 rounded-full text-sm font-medium transition-colors">æ‰“åŒ…ä¸‹è½½</button>
        <button onclick="batchDeletePrompt()" class="bg-red-600 hover:bg-red-500 px-4 py-1.5 rounded-full text-sm font-medium transition-colors">æ‰¹é‡åˆ é™¤</button>
        <button onclick="toggleBatchMode(true)" class="p-1 hover:bg-slate-800 dark:hover:bg-slate-700 rounded-full ml-1 text-slate-400 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </div>

    <div id="uploadModal" class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hide opacity-0 transition-all duration-300">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md p-6 m-4 max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-300" id="modalContent">
            <h2 class="text-xl font-bold mb-5 text-slate-800 dark:text-white" id="modalTitle">å½•å…¥æ–°å¡ç‰‡</h2>
            <form id="uploadForm" class="space-y-4">
                <input type="hidden" id="editItemId" value="">
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">å±•ç¤ºå°é¢å›¾ <span id="imgRequired">(å¿…å¡«)</span></label>
                    <input type="file" id="imageInput" accept="image/png, image/jpeg, image/webp" class="block w-full text-sm text-slate-500 dark:text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 dark:file:bg-indigo-900/50 dark:file:text-indigo-300">
                </div>
                <div id="rawFileContainer">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">ç»‘å®šåŸæ–‡ä»¶ (å¯é€‰ï¼Œæ”¯æŒ .png / .json)</label>
                    <input type="file" id="rawFileInput" accept=".png,.json" class="block w-full text-sm text-slate-500 dark:text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 dark:file:bg-emerald-900/50 dark:file:text-emerald-300">
                </div>
                <div>
                    <input type="text" id="nameInput" placeholder="åç§° (ä¾‹: æ–¯æ–‡è´¥ç±»é‚»å®¶å“¥å“¥)" required class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 dark:bg-slate-900 dark:text-white transition-colors text-sm">
                </div>
                <div>
                    <input type="text" id="tagsInput" placeholder="åˆ†ç±»æ ‡ç­¾ (ç”¨é€—å·åˆ†éš”)" required class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 dark:bg-slate-900 dark:text-white transition-colors text-sm">
                </div>
                <div>
                    <textarea id="noteInput" rows="3" placeholder="è®¾å®šè¯´æ˜..." class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 dark:bg-slate-900 dark:text-white transition-colors resize-none text-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <button type="button" onclick="closeModal('uploadModal')" class="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors font-medium text-sm">å–æ¶ˆ</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-colors font-medium text-sm shadow-md">ä¿å­˜å…¥åº“</button>
                </div>
            </form>
        </div>
    </div>

    <div id="lightbox" class="fixed inset-0 bg-black/95 z-[60] hide flex items-center justify-center cursor-zoom-out" onclick="closeLightbox()">
        <img id="lightboxImg" src="" class="max-h-[90vh] max-w-[90vw] object-contain rounded-lg shadow-2xl transition-transform duration-300 scale-95">
    </div>

    <div id="toastContainer" class="fixed top-6 left-1/2 -translate-x-1/2 z-[70] flex flex-col gap-2 pointer-events-none"></div><script>
        const dbName = 'TavernGalleryProMax';
        let db;

        let state = {
            activeTab: 'cards',
            data: { cards: [], worldbooks: [] },
            currentCategory: 'all',
            searchQuery: '',
            itemsPerPage: 9,
            currentPage: 1,
            isBatchMode: false,
            selectedIds: new Set()
        };

        // UI Toast é€šçŸ¥å·¥å…·
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-slate-800 dark:bg-slate-700';
            toast.className = `px-4 py-2 rounded-full shadow-lg text-white text-sm font-medium ${bg} toast-enter flex items-center gap-2`;
            toast.innerHTML = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('toast-enter', 'toast-leave');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };

        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onerror = () => { showToast('æ•°æ®åº“åˆå§‹åŒ–å¤±è´¥', 'error'); reject('æ•°æ®åº“é”™è¯¯'); };
            request.onsuccess = (e) => { db = e.target.result; resolve(); };
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('cards')) db.createObjectStore('cards', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('worldbooks')) db.createObjectStore('worldbooks', { keyPath: 'id' });
            };
        });

        const dbOps = {
            getAll: (store) => new Promise(res => { const req = db.transaction(store, 'readonly').objectStore(store).getAll(); req.onsuccess = () => res(req.result.sort((a,b)=>b.id-a.id)); }),
            add: (store, item) => new Promise(res => { const tx = db.transaction(store, 'readwrite'); tx.objectStore(store).put(item); tx.oncomplete = () => res(); }),
            delete: (store, id) => new Promise(res => { const tx = db.transaction(store, 'readwrite'); tx.objectStore(store).delete(id); tx.oncomplete = () => res(); }),
            clearAll: (store) => new Promise(res => { const tx = db.transaction(store, 'readwrite'); tx.objectStore(store).clear(); tx.oncomplete = () => res(); })
        };

        function initTheme() {
            const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
            if (isDark) document.documentElement.classList.add('dark');
            updateThemeIcons();
        }

        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark'); localStorage.setItem('theme', 'light');
            } else {
                html.classList.add('dark'); localStorage.setItem('theme', 'dark');
            }
            updateThemeIcons();
        }

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const svg = isDark ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            document.getElementById('themeIconM').innerHTML = svg;
            document.getElementById('themeIconPC').innerHTML = svg;
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar'), overlay = document.getElementById('sidebarOverlay');
            sb.classList.toggle('sidebar-closed'); overlay.classList.toggle('hide');
        }

        function switchTab(tab) {
            state.activeTab = tab; state.currentCategory = 'all'; state.currentPage = 1; state.isBatchMode = false; state.selectedIds.clear();
            
            document.getElementById('tab-cards-pc').className = tab === 'cards' ? 'px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all' : 'px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-all';
            document.getElementById('tab-wb-pc').className = tab === 'worldbooks' ? 'px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all' : 'px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-all';
            document.getElementById('tab-cards-m').className = tab === 'cards' ? 'px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white' : 'px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400';
            document.getElementById('tab-wb-m').className = tab === 'worldbooks' ? 'px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white' : 'px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400';
            
            document.getElementById('batchToggle').checked = false;
            toggleBatchMode(true); 
            updateView();
        }

        function toggleBatchMode(forceClose = false) {
            if (forceClose) state.isBatchMode = false;
            else state.isBatchMode = !state.isBatchMode;
            
            state.selectedIds.clear();
            const toggleUI = document.getElementById('batchToggleUI'), actionBar = document.getElementById('batchActionBar');
            
            if (state.isBatchMode) {
                toggleUI.classList.remove('bg-slate-300', 'dark:bg-slate-600'); toggleUI.classList.add('bg-indigo-500');
                toggleUI.firstElementChild.style.transform = 'translateX(100%)';
                actionBar.classList.remove('batch-bar-hidden');
            } else {
                toggleUI.classList.add('bg-slate-300', 'dark:bg-slate-600'); toggleUI.classList.remove('bg-indigo-500');
                toggleUI.firstElementChild.style.transform = 'translateX(0)';
                actionBar.classList.add('batch-bar-hidden');
            }
            updateView();
        }// æ ¸å¿ƒæ¸²æŸ“ä¸çŠ¶æ€æ›´æ–°é€»è¾‘
        function updateView() {
            const currentData = state.data[state.activeTab] || [];
            
            // æ¸²æŸ“ä¾§è¾¹æ åˆ†ç±»
            const allTags = new Set();
            currentData.forEach(item => item.tags.forEach(t => allTags.add(t)));
            const listEl = document.getElementById('categoryList');
            
            let html = `<button onclick="setCategory('all')" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${state.currentCategory === 'all' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}">å…¨éƒ¨</button>`;
            Array.from(allTags).sort().forEach(tag => {
                const isActive = state.currentCategory === tag;
                html += `<button onclick="setCategory('${tag}')" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}">${tag}</button>`;
            });
            listEl.innerHTML = html;

            // è¿‡æ»¤æ•°æ® (åˆ†ç±» + æœç´¢å®æ—¶è¿‡æ»¤)
            let filtered = currentData;
            if (state.currentCategory !== 'all') filtered = filtered.filter(c => c.tags.includes(state.currentCategory));
            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(c => c.name.toLowerCase().includes(q) || c.tags.join(' ').toLowerCase().includes(q) || (c.note && c.note.toLowerCase().includes(q)));
            }
            document.getElementById('cardCount').textContent = `å…± ${filtered.length} é¡¹`;

            // åˆ†é¡µè®¡ç®—
            const isShowAll = state.itemsPerPage === Infinity;
            const totalPages = isShowAll ? 1 : Math.ceil(filtered.length / state.itemsPerPage) || 1;
            if (state.currentPage > totalPages) state.currentPage = totalPages;
            if (state.currentPage < 1) state.currentPage = 1;
            
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('pageInput').value = state.currentPage;
            
            const paginationEl = document.getElementById('paginationCtrl');
            if (isShowAll || filtered.length <= state.itemsPerPage) paginationEl.classList.add('hide');
            else paginationEl.classList.remove('hide');

            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            renderItems(isShowAll ? filtered : filtered.slice(startIndex, startIndex + state.itemsPerPage));
        }

        function setCategory(tag) { state.currentCategory = tag; state.currentPage = 1; updateView(); }
        function toggleViewMode() { state.itemsPerPage = document.getElementById('viewToggle').checked ? Infinity : 9; state.currentPage = 1; updateView(); }
        function changePage(delta) { state.currentPage += delta; updateView(); window.scrollTo({ top: 0, behavior: 'smooth' }); }
        function jumpToPage() { const val = parseInt(document.getElementById('pageInput').value); if (!isNaN(val)) { state.currentPage = val; updateView(); window.scrollTo({ top: 0, behavior: 'smooth' }); } }
        function handleSearch(query) { state.searchQuery = query.trim(); state.currentPage = 1; updateView(); }

        function toggleSelection(id) {
            if (!state.isBatchMode) return;
            if (state.selectedIds.has(id)) state.selectedIds.delete(id);
            else state.selectedIds.add(id);
            document.getElementById('selectedCount').textContent = state.selectedIds.size;
            updateView();
        }

        // å¡ç‰‡æ¸²æŸ“å¼•æ“
        function renderItems(items) {
            const grid = document.getElementById('cardGrid'); grid.innerHTML = '';
            if (items.length === 0) {
                document.getElementById('emptyState').classList.remove('hide');
                document.getElementById('emptyText').textContent = state.activeTab === 'cards' ? 'æ­¤åˆ†ç±»ä¸‹æš‚æ— è§’è‰²å¡' : 'æ­¤åˆ†ç±»ä¸‹æš‚æ— ä¸–ç•Œä¹¦';
                return;
            }
            document.getElementById('emptyState').classList.add('hide');
            
            items.forEach(item => {
                const isSelected = state.selectedIds.has(item.id);
                const cardClass = `bg-white dark:bg-slate-800 rounded-2xl shadow-sm overflow-hidden transition-all duration-300 group flex flex-col ${state.isBatchMode ? 'card-selectable' : 'hover:shadow-lg'} ${isSelected ? 'card-selected' : 'border border-slate-200/60 dark:border-slate-700'}`;
                const tagsHtml = item.tags.map(tag => `<span onclick="event.stopPropagation(); if(!state.isBatchMode) setCategory('${tag}')" class="bg-slate-100 dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 px-2 py-0.5 rounded text-[10px] font-medium ${state.isBatchMode ? '' : 'cursor-pointer hover:bg-indigo-100 dark:hover:bg-slate-600'}">${tag}</span>`).join('');
                const fileBadge = item.rawFile ? `<div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-full flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg> åŸæ–‡ä»¶</div>` : '';

                const el = document.createElement('div');
                el.className = cardClass;
                el.onclick = () => toggleSelection(item.id);
                el.innerHTML = `
                    <div class="relative w-full aspect-[2/3] overflow-hidden bg-slate-100 dark:bg-slate-900 ${state.isBatchMode ? '' : 'cursor-zoom-in'}" onclick="if(!state.isBatchMode) { event.stopPropagation(); openLightbox('${item.image}'); }">
                        <img src="${item.image}" loading="lazy" class="w-full h-full object-cover object-top ${state.isBatchMode ? '' : 'group-hover:scale-105'} transition-transform duration-500">
                        ${fileBadge}
                        ${isSelected ? '<div class="absolute inset-0 bg-indigo-600/30 flex items-center justify-center"><div class="bg-indigo-600 text-white rounded-full p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div></div>' : ''}
                    </div>
                    <div class="p-3.5 flex flex-col flex-grow">
                        <h3 class="font-bold text-slate-800 dark:text-slate-200 text-base mb-1.5 line-clamp-1">${item.name}</h3>
                        <div class="flex flex-wrap gap-1 mb-2">${tagsHtml}</div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 flex-grow mb-3 leading-relaxed">${item.note || 'æš‚æ— è®¾å®š'}</p>
                        <div class="flex justify-between items-center pt-2 border-t border-slate-100 dark:border-slate-700 ${state.isBatchMode ? 'opacity-50 pointer-events-none' : ''}">
                            <button onclick="event.stopPropagation(); downloadItem('${item.id}')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 hover:bg-indigo-50 dark:hover:bg-slate-700 px-2 py-1 -ml-2 rounded text-xs font-semibold transition-colors">ä¸‹è½½</button>
                            <div class="flex gap-1">
                                <button onclick="event.stopPropagation(); editItem(${item.id})" class="text-amber-500 hover:bg-amber-50 dark:hover:bg-slate-700 px-2 py-1 rounded text-xs font-semibold transition-colors">ç¼–è¾‘</button>
                                <button onclick="event.stopPropagation(); deleteItem(${item.id})" class="text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-slate-700 px-2 py-1 -mr-2 rounded text-xs font-semibold transition-colors">åˆ é™¤</button>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(el);
            });
        }

        // å›¾ç‰‡ç¯ç®±åŠŸèƒ½
        function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').classList.remove('hide'); setTimeout(()=>document.getElementById('lightboxImg').classList.remove('scale-95'), 10); }
        function closeLightbox() { document.getElementById('lightboxImg').classList.add('scale-95'); setTimeout(()=>document.getElementById('lightbox').classList.add('hide'), 300); }// å½•å…¥ä¸ç¼–è¾‘é€»è¾‘
        function openUploadModal() { 
            document.getElementById('editItemId').value = '';
            document.getElementById('imageInput').required = true;
            document.getElementById('imgRequired').textContent = '(å¿…å¡«)';
            document.getElementById('modalTitle').textContent = state.activeTab === 'cards' ? 'å½•å…¥æ–°è§’è‰²' : 'å½•å…¥ä¸–ç•Œä¹¦'; 
            toggleModal('uploadModal'); 
        }

        function editItem(id) {
            const item = state.data[state.activeTab].find(i => i.id === id);
            if(!item) return;
            document.getElementById('editItemId').value = item.id;
            document.getElementById('nameInput').value = item.name;
            document.getElementById('tagsInput').value = item.tags.join(', ');
            document.getElementById('noteInput').value = item.note || '';
            
            document.getElementById('imageInput').required = false;
            document.getElementById('imgRequired').textContent = '(å¯é€‰ï¼Œç•™ç©ºåˆ™ä¸ä¿®æ”¹)';
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å¡ç‰‡ä¿¡æ¯';
            toggleModal('uploadModal');
        }

        function closeModal(id) { toggleModal(id, true); setTimeout(()=>document.getElementById('uploadForm').reset(), 300); }
        function toggleModal(id, forceClose=false) {
            const m = document.getElementById(id), c = document.getElementById('modalContent');
            if (forceClose || !m.classList.contains('hide')) { m.classList.add('opacity-0'); c.classList.add('scale-95'); setTimeout(() => m.classList.add('hide'), 300); }
            else { m.classList.remove('hide'); void m.offsetWidth; m.classList.remove('opacity-0'); c.classList.remove('scale-95'); }
        }

        const fileToBase64 = (file) => new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const editId = document.getElementById('editItemId').value;
            const imgFile = document.getElementById('imageInput').files[0], rawFile = document.getElementById('rawFileInput').files[0];
            
            try {
                let imgBase64 = null, rawBase64 = null, rawFileName = null;
                
                if (editId) {
                    const existing = state.data[state.activeTab].find(i => i.id == editId);
                    imgBase64 = imgFile ? await fileToBase64(imgFile) : existing.image;
                    rawBase64 = rawFile ? await fileToBase64(rawFile) : existing.rawFile;
                    rawFileName = rawFile ? rawFile.name : existing.rawFileName;
                } else {
                    if (!imgFile) return showToast('å¿…é¡»ä¸Šä¼ å°é¢å›¾', 'error');
                    imgBase64 = await fileToBase64(imgFile);
                    if (rawFile) { rawBase64 = await fileToBase64(rawFile); rawFileName = rawFile.name; }
                }

                const tagsStr = document.getElementById('tagsInput').value;
                const newItem = { 
                    id: editId ? parseInt(editId) : Date.now(), 
                    name: document.getElementById('nameInput').value, 
                    tags: tagsStr ? tagsStr.split(/[,ï¼Œ]/).map(t => t.trim()).filter(t => t) : ['æœªåˆ†ç±»'], 
                    note: document.getElementById('noteInput').value, 
                    image: imgBase64, 
                    rawFile: rawBase64, 
                    rawFileName: rawFileName 
                };
                
                await dbOps.add(state.activeTab, newItem); 
                state.data[state.activeTab] = await dbOps.getAll(state.activeTab); 
                updateView(); 
                closeModal('uploadModal');
                showToast(editId ? 'ç¼–è¾‘æˆåŠŸ' : 'å½•å…¥æˆåŠŸ', 'success');
            } catch (err) { showToast('æ“ä½œå¤±è´¥: ' + err, 'error'); }
        });

        // ä¸‹è½½ä¸åˆ é™¤åŠŸèƒ½
        function downloadItem(id) { 
            const item = state.data[state.activeTab].find(i => i.id == id); 
            if (!item) return; 
            const a = document.createElement('a'); 
            if (item.rawFile) { a.href = item.rawFile; a.download = item.rawFileName || `${item.name}_raw.file`; } 
            else { a.href = item.image; a.download = `${item.name}.png`; } 
            a.click(); 
        }

        async function deleteItem(id) { 
            if (confirm('ç¡®è®¤åˆ é™¤æ­¤é¡¹ï¼Ÿä¸å¯æ¢å¤å“¦ï¼')) { 
                await dbOps.delete(state.activeTab, id);
                state.data[state.activeTab] = await dbOps.getAll(state.activeTab);
                updateView();
                showToast('å·²åˆ é™¤', 'success');
            }
        }

        // æ‰¹é‡æ“ä½œ (å¸¦å»¶è¿Ÿé˜²æ¼çš„é€å¼ ä¸‹è½½æœºåˆ¶)
        async function batchDownload() {
            if(state.selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©è¦ä¸‹è½½çš„é¡¹', 'error');
            showToast(`å‡†å¤‡æ‰¹é‡ä¸‹è½½ ${state.selectedIds.size} é¡¹...`, 'info');
            const ids = Array.from(state.selectedIds);
            
            for (let i = 0; i < ids.length; i++) {
                setTimeout(() => {
                    downloadItem(ids[i]);
                }, i * 800); // è®¾ç½® 800ms çš„é—´éš”ï¼Œé˜²æ­¢æµè§ˆå™¨æ‹¦æˆªæˆ–æ¼ä¸‹
            }
            
            setTimeout(() => {
                toggleBatchMode(true);
                showToast('æ‰¹é‡ä¸‹è½½ä»»åŠ¡å·²å…¨éƒ¨è§¦å‘', 'success');
            }, ids.length * 800 + 500);
        }

        function batchDeletePrompt() {
            if(state.selectedIds.size === 0) return showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„é¡¹', 'error');
            if(confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${state.selectedIds.size} é¡¹å—ï¼Ÿ`)) batchDelete();
        }

        async function batchDelete() {
            for (let id of state.selectedIds) {
                await dbOps.delete(state.activeTab, id);
            }
            state.data[state.activeTab] = await dbOps.getAll(state.activeTab);
            toggleBatchMode(true);
            updateView();
            showToast('æ‰¹é‡åˆ é™¤æˆåŠŸ', 'success');
        }

        // æ•°æ®å¯¼å…¥ä¸å¯¼å‡º
        async function exportData() {
            try {
                const cards = await dbOps.getAll('cards');
                const worldbooks = await dbOps.getAll('worldbooks');
                const dataStr = JSON.stringify({ cards, worldbooks });
                const blob = new Blob([dataStr], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `TavernData_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`;
                a.click();
                showToast('æ•°æ®å¯¼å‡ºæˆåŠŸ', 'success');
            } catch(e) { showToast('å¯¼å‡ºå¤±è´¥', 'error'); }
        }

        function importData(e) {
            const file = e.target.files[0];
            if(!file) return;
            if(!confirm('å¯¼å…¥å°†è¦†ç›–å½“å‰åŒåIDæ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) return;
            
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const data = JSON.parse(ev.target.result);
                    if(data.cards) for(let c of data.cards) await dbOps.add('cards', c);
                    if(data.worldbooks) for(let w of data.worldbooks) await dbOps.add('worldbooks', w);
                    
                    state.data.cards = await dbOps.getAll('cards');
                    state.data.worldbooks = await dbOps.getAll('worldbooks');
                    updateView();
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸ', 'success');
                } catch(err) { showToast('å¯¼å…¥å¤±è´¥ï¼Œæ–‡ä»¶æ ¼å¼é”™è¯¯', 'error'); }
            };
            reader.readAsText(file);
            e.target.value = ''; // Reset
        }

        // é¡µé¢å¯åŠ¨åˆå§‹åŒ–
        window.onload = async () => {
            initTheme();
            try {
                await initDB();
                state.data.cards = await dbOps.getAll('cards');
                state.data.worldbooks = await dbOps.getAll('worldbooks');
                updateView();
                showToast('æ•°æ®åŠ è½½å®Œæ¯•', 'success');
            } catch (e) {
                console.error(e);
            }
        };
    </script>
</body>

</html>
