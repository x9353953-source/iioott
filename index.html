<!DOCTYPE html>
<html lang="zh" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tavern Gallery Pro Max</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4f46e5">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Tavern Gallery">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/googlefonts/noto-emoji/main/png/512/emoji_u1f340.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script><style type="text/tailwindcss">
        /* Firefox æ»šåŠ¨æ¡ */
        html { scrollbar-width: thin; scrollbar-color: #cbd5e1 transparent; }
        .dark html { scrollbar-color: #475569 transparent; }
        
        /* Webkit æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .hide { display: none !important; }
        .glass-nav { @apply bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200/50 dark:border-slate-700/50; }
        .glass-sidebar { @apply bg-white dark:bg-slate-900 shadow-[4px_0_24px_rgba(0,0,0,0.15)]; }
        
        /* Toggle å¼€å…³åŠ¨ç”» */
        .toggle-checkbox:checked { right: 0; border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label:after { transform: translateX(100%); border-color: white; }

        .sidebar-drawer { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .sidebar-closed { transform: translateX(-100%); }
        
        /* å¡ç‰‡é€‰ä¸­çŠ¶æ€ */
        .card-selected { border-color: #4f46e5 !important; border-width: 2px !important; transform: scale(0.96); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
        .card-selectable { cursor: pointer; }
        .card-selectable:hover { border-color: #818cf8; }

        /* åº•éƒ¨æ“ä½œæ åŠ¨ç”» */
        .batch-bar { transform: translateX(-50%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s; }
        .batch-bar-hidden { transform: translate(-50%, 150%); opacity: 0; pointer-events: none; }
        
        /* Toast æç¤ºåŠ¨ç”» */
        .toast-enter { animation: toastIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        .toast-leave { animation: toastOut 0.3s ease-in forwards; }
        @keyframes toastIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes toastOut { from { transform: translateY(0); opacity: 1; } to { transform: translateY(-20px); opacity: 0; } }
    </style>
</head><body class="bg-slate-50 dark:bg-slate-950 min-h-screen font-sans text-slate-800 dark:text-slate-200 transition-colors duration-300 flex flex-col overflow-x-hidden">
    <header class="glass-nav sticky top-0 z-40">
        <div class="max-w-[1400px] mx-auto px-4 py-3 sm:px-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="p-2 -ml-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg md:hidden transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    <h1 class="text-xl sm:text-2xl font-bold text-indigo-600 dark:text-indigo-400 tracking-tight flex items-center gap-2">
                        Tavern Gallery
                    </h1>
                </div>
                
                <div class="flex items-center gap-2 md:hidden">
                    <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:text-indigo-500 dark:text-slate-400 dark:hover:text-amber-400 transition-colors">
                        <svg id="themeIconM" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
                    </button>
                    <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg">
                        <button onclick="switchTab('cards')" id="tab-cards-m" class="px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all">è§’è‰²å¡</button>
                        <button onclick="switchTab('worldbooks')" id="tab-wb-m" class="px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 transition-all">ä¸–ç•Œä¹¦</button>
                    </div>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                <div class="hidden md:flex items-center gap-3">
                    <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:text-indigo-500 dark:text-slate-400 dark:hover:text-amber-400 transition-colors">
                        <svg id="themeIconPC" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
                    </button>
                    <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-lg mr-2">
                        <button onclick="switchTab('cards')" id="tab-cards-pc" class="px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all">è§’è‰²å¡</button>
                        <button onclick="switchTab('worldbooks')" id="tab-wb-pc" class="px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-all">ä¸–ç•Œä¹¦</button>
                    </div>
                </div>

                <input type="text" id="searchInput" oninput="handleSearch(this.value)" placeholder="æœç´¢åç§°ã€æ ‡ç­¾æˆ–å¤‡æ³¨..." 
                    class="px-4 py-2 text-sm border border-slate-300 dark:border-slate-600 rounded-full focus:ring-2 focus:ring-indigo-500 outline-none flex-1 sm:flex-none sm:w-48 bg-white/50 dark:bg-slate-800/50 dark:text-white transition-all shadow-sm">
                
                <button onclick="openUploadModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full text-sm font-medium transition-all shadow-md active:scale-95 shrink-0">
                    + æ–°å¢è®°å½•
                </button>
            </div>
        </div>
    </header><div id="sidebarOverlay" class="fixed inset-0 bg-slate-900/40 dark:bg-black/60 z-40 hide backdrop-blur-sm transition-opacity" onclick="toggleSidebar()"></div>
    <aside id="sidebar" class="sidebar-drawer sidebar-closed fixed left-0 top-0 h-full w-72 md:w-80 glass-sidebar shadow-2xl z-50 p-6 overflow-y-auto flex flex-col border-r border-slate-200/50 dark:border-slate-700/50">
        <div class="flex justify-between items-center mb-8">
            <h3 class="text-sm font-bold text-slate-800 dark:text-slate-200 flex items-center gap-2">
                <svg class="w-5 h-5 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path></svg>
                æ ‡ç­¾åˆ†ç±»
            </h3>
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 p-1.5 bg-slate-100 dark:bg-slate-800 rounded-full transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <div id="categoryList" class="flex flex-wrap gap-2 mb-auto pb-6">
            </div>
        
        <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-700 space-y-3">
            <p class="text-xs text-slate-400 dark:text-slate-500 mb-2 font-medium">æ•°æ®ç®¡ç† (æœ¬åœ°å­˜å‚¨)</p>
            <button onclick="exportData()" class="w-full flex items-center justify-center gap-2 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 dark:hover:bg-slate-600 text-white px-4 py-2.5 rounded-xl text-sm font-medium transition-all shadow-md">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                å¤‡ä»½å…¨éƒ¨æ•°æ®
            </button>
            <label class="w-full flex items-center justify-center gap-2 bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2.5 rounded-xl text-sm font-medium transition-all shadow-md cursor-pointer">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                <input type="file" id="importInput" accept=".json" class="hidden" onchange="importData(event)">      
                å¯¼å…¥å¤‡ä»½æ•°æ®
            </label>
        </div>
    </aside><main class="flex-1 w-full max-w-[1400px] mx-auto px-4 py-6 flex flex-col relative pb-24">
        <div class="flex justify-between items-center bg-white dark:bg-slate-800 p-3 rounded-2xl shadow-sm border border-slate-200/60 dark:border-slate-700 mb-4 flex-wrap gap-2 transition-colors">
            <div class="flex items-center gap-3 px-2">
                <button onclick="toggleSidebar()" class="hidden md:flex items-center gap-1 text-sm font-medium text-slate-600 dark:text-slate-300 hover:text-indigo-600 dark:hover:text-indigo-400 bg-slate-100 dark:bg-slate-700 px-3 py-1.5 rounded-lg transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                    ç­›é€‰å™¨
                </button>
                <span id="cardCount" class="text-sm text-slate-500 dark:text-slate-400 font-medium">å…± 0 æ¡è®°å½•</span>
            </div>
            
            <div class="flex items-center gap-4 pr-2">
                <label class="flex items-center gap-2 cursor-pointer">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300">æ‰¹é‡æ¨¡å¼</span>
                    <input type="checkbox" id="batchToggle" class="hidden" onchange="toggleBatchMode()">
                    <div id="batchToggleUI" class="w-10 h-6 bg-slate-300 dark:bg-slate-600 rounded-full p-1 transition-colors duration-300">
                        <div class="w-4 h-4 bg-white rounded-full shadow-md transform transition-transform duration-300"></div>
                    </div>
                </label>
                <div class="h-4 w-px bg-slate-300 dark:bg-slate-600"></div>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300">åˆ†é¡µæ˜¾ç¤º</span>
                    <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" id="viewToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 dark:border-slate-500 appearance-none cursor-pointer z-10" onclick="toggleViewMode()"/>
                        <label for="viewToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 dark:bg-slate-600 cursor-pointer"></label>
                    </div>
                    <span class="text-sm font-medium text-slate-600 dark:text-slate-300 text-xs">å…¨éƒ¨æ˜¾ç¤º</span>
                </div>
            </div>
        </div>

        <div id="cardGrid" class="grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-5 mb-6">
            </div>
        
        <div id="emptyState" class="text-center py-24 hide bg-white dark:bg-slate-800 rounded-2xl border border-slate-200/60 dark:border-slate-700 transition-colors">
            <div class="text-5xl mb-4 opacity-50">ğŸƒ</div>
            <h3 class="text-slate-500 dark:text-slate-400 font-medium" id="emptyText">è¿™é‡Œç©ºç©ºå¦‚ä¹Ÿï¼Œç‚¹å‡»å³ä¸Šè§’æ·»åŠ å§</h3>
        </div>
                <div id="paginationCtrl" class="batch-bar batch-bar-hidden fixed bottom-6 left-1/2 bg-white/95 dark:bg-slate-800/95 backdrop-blur-md text-slate-700 dark:text-white px-5 py-3 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.15)] dark:shadow-[0_10px_40px_rgba(0,0,0,0.3)] z-[35] flex items-center gap-3 border border-slate-200 dark:border-slate-600 whitespace-nowrap transition-all duration-300">
            <button onclick="changePage(-1)" class="px-3 py-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-200 transition-colors font-medium text-sm">ä¸Šä¸€é¡µ</button>
            <div class="flex items-center gap-2 px-3 border-x border-slate-300 dark:border-slate-600">
                <span class="text-sm font-medium text-slate-500 dark:text-slate-300">ç¬¬</span>
                <input type="number" id="pageInput" min="1" value="1" class="w-12 text-center py-1 bg-slate-50 dark:bg-slate-900/50 border border-slate-300 dark:border-slate-500 rounded-md outline-none text-sm text-slate-700 dark:text-white focus:ring-2 focus:ring-indigo-500 transition-all shadow-inner" onchange="jumpToPage()">
                <span class="text-sm font-medium text-slate-500 dark:text-slate-400">/ <span id="totalPages">1</span> é¡µ</span>
            </div>
            <button onclick="changePage(1)" class="px-3 py-1.5 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-200 transition-colors font-medium text-sm">ä¸‹ä¸€é¡µ</button>
        </div>
    </main>

    <div id="batchActionBar" class="batch-bar batch-bar-hidden fixed bottom-6 left-1/2 bg-white/95 dark:bg-slate-800/95 backdrop-blur-md text-slate-700 dark:text-white px-5 py-3 rounded-full shadow-[0_10px_40px_rgba(0,0,0,0.15)] dark:shadow-[0_10px_40px_rgba(0,0,0,0.3)] z-40 flex items-center gap-3 border border-slate-200 dark:border-slate-600 whitespace-nowrap transition-all duration-300">
        <span class="text-sm font-medium mr-1">å·²é€‰æ‹© <span id="selectedCount" class="text-indigo-600 dark:text-indigo-400 font-bold text-lg">0</span></span>
        <div class="w-px h-5 bg-slate-300 dark:bg-slate-600"></div>
        <button onclick="openDownloadModal('batch')" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-full text-sm font-medium transition-colors shadow-sm">æ‰¹é‡ä¸‹è½½</button>
        <button onclick="batchDeletePrompt()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-1.5 rounded-full text-sm font-medium transition-colors shadow-sm">æ‰¹é‡åˆ é™¤</button>
        <button onclick="toggleBatchMode(true)" class="p-1 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-full ml-1 text-slate-500 dark:text-slate-400 transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
    </div>
    <div id="uploadModal" class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hide opacity-0 transition-all duration-300">
        <div class="bg-white dark:bg-slate-800 rounded-3xl shadow-2xl w-full max-w-md p-6 m-4 max-h-[90vh] overflow-y-auto transform scale-95 transition-all duration-300" id="modalContent">
            <h2 class="text-xl font-bold mb-5 text-slate-800 dark:text-white" id="modalTitle">æ–°å¢è®°å½•</h2>
            <form id="uploadForm" class="space-y-4">
                <input type="hidden" id="editItemId" value="">
                <input type="hidden" id="flagDeleteImage" value="false">
                <input type="hidden" id="flagDeleteRaw" value="false">
                <input type="hidden" id="flagDeleteCompanion" value="false">
                
                <div>
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">å°é¢å›¾ç‰‡ <span id="imgRequired">(å¿…å¡«)</span></label>
                    <div id="existingImageUI" class="hidden items-center justify-between bg-slate-100 dark:bg-slate-700 p-2 rounded-lg mb-2">
                        <span class="text-sm text-slate-600 dark:text-slate-300">å·²åŒ…å«å›¾ç‰‡ (ç•™ç©ºåˆ™ä¿ç•™åŸå›¾)</span>
                        <button type="button" onclick="markDeleteFile('Image')" class="text-xs font-bold text-red-500 hover:text-red-600 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded">åˆ é™¤åŸå›¾</button>
                    </div>
                    <input type="file" id="imageInput" accept="image/png, image/jpeg, image/webp" class="block w-full text-sm text-slate-500 dark:text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 dark:file:bg-indigo-900/50 dark:file:text-indigo-300">
                </div>
                
                <div id="rawFileContainer">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">åŸå§‹æ•°æ® (é€æ˜ .png / .json æ–‡ä»¶)</label>
                    <div id="existingRawUI" class="hidden items-center justify-between bg-slate-100 dark:bg-slate-700 p-2 rounded-lg mb-2">
                        <span id="existingRawName" class="text-sm text-slate-600 dark:text-slate-300 truncate mr-2"></span>
                        <button type="button" onclick="markDeleteFile('Raw')" class="text-xs font-bold text-red-500 hover:text-red-600 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded shrink-0">åˆ é™¤æ–‡ä»¶</button>
                    </div>
                    <input type="file" id="rawFileInput" accept=".png,.json" class="block w-full text-sm text-slate-500 dark:text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 dark:file:bg-emerald-900/50 dark:file:text-emerald-300">
                </div>

                <div id="companionFileContainer">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-1">Companion é™„åŠ æ–‡ä»¶ (å¯é€‰)</label>
                    <div id="existingCompanionUI" class="hidden items-center justify-between bg-slate-100 dark:bg-slate-700 p-2 rounded-lg mb-2">
                        <span id="existingCompanionName" class="text-sm text-slate-600 dark:text-slate-300 truncate mr-2"></span>
                        <button type="button" onclick="markDeleteFile('Companion')" class="text-xs font-bold text-red-500 hover:text-red-600 bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded shrink-0">åˆ é™¤æ–‡ä»¶</button>
                    </div>
                    <input type="file" id="companionFileInput" class="block w-full text-sm text-slate-500 dark:text-slate-300 file:mr-4 file:py-2 file:px-4 file:rounded-xl file:border-0 file:text-sm file:font-semibold file:bg-amber-50 file:text-amber-700 dark:file:bg-amber-900/50 dark:file:text-amber-300">
                </div>

                <div>
                    <input type="text" id="nameInput" placeholder="åç§° (å¦‚ è§’è‰²å / ä¸–ç•Œä¹¦å)" required class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 dark:bg-slate-900 dark:text-white transition-colors text-sm">
                </div>
                <div>
                    <input type="text" id="tagsInput" placeholder="æ ‡ç­¾ (è‹±æ–‡é€—å·åˆ†éš”ï¼Œå¦‚ è®¾å®š,å¥‡å¹»)" required class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 dark:bg-slate-900 dark:text-white transition-colors text-sm">
                </div>
                <div>
                    <textarea id="noteInput" rows="3" placeholder="å¤‡æ³¨æˆ–ç®€ä»‹..." class="w-full px-4 py-2.5 border border-slate-200 dark:border-slate-600 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none bg-slate-50 dark:bg-slate-900 dark:text-white transition-colors resize-none text-sm"></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4 border-t border-slate-100 dark:border-slate-700">
                    <button type="button" onclick="closeModal('uploadModal', 'modalContent')" class="px-5 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors font-medium text-sm">å–æ¶ˆ</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-colors font-medium text-sm shadow-md">ä¿å­˜è®°å½•</button>
                </div>
            </form>
        </div>
    </div>
    <div id="downloadModal" class="fixed inset-0 bg-slate-900/50 dark:bg-black/70 backdrop-blur-sm flex items-center justify-center z-[60] hide opacity-0 transition-all duration-300">
        <div class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl w-full max-w-sm p-6 m-4 transform scale-95 transition-all duration-300" id="downloadModalContent">
            <h2 class="text-lg font-bold mb-4 text-slate-800 dark:text-white">é€‰æ‹©è¦ä¸‹è½½çš„æ–‡ä»¶</h2>
            <input type="hidden" id="dlTargetId" value="">
            
            <div class="space-y-3 mb-6" id="downloadOptions">
                </div>
            
            <div class="flex justify-end gap-3 pt-2 border-t border-slate-100 dark:border-slate-700 pt-4">
                <button type="button" onclick="closeModal('downloadModal', 'downloadModalContent')" class="px-4 py-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-xl transition-colors font-medium text-sm">å–æ¶ˆ</button>
                <button onclick="executeDownload()" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl transition-colors font-medium text-sm shadow-md">ç¡®è®¤ä¸‹è½½</button>
            </div>
        </div>
    </div>
    <div id="lightbox" class="fixed inset-0 bg-slate-900/90 dark:bg-black/95 backdrop-blur-xl z-[70] hide flex flex-col items-center justify-center transition-opacity" onclick="closeLightbox()">
        <button onclick="closeLightbox()" class="absolute top-6 right-6 text-white hover:text-red-400 bg-black/50 hover:bg-black/80 p-2 rounded-full transition-all z-50">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
        <img id="lightboxImg" src="" class="max-w-[95vw] max-h-[90vh] object-contain rounded-lg shadow-2xl transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
    </div>

    <div id="toastContainer" class="fixed top-20 left-1/2 transform -translate-x-1/2 z-[100] flex flex-col items-center gap-2 pointer-events-none"></div>

    <script>
        const dbName = 'TavernGalleryProMax';
        let db;

        // å…¨å±€çŠ¶æ€ç®¡ç†
        let state = {
            activeTab: 'cards',
            data: { cards: [], worldbooks: [] }, // è¿™é‡Œç°åœ¨åªå­˜è½»é‡çº§çš„å…ƒæ•°æ®ï¼Œä¸å­˜å¤§æ–‡ä»¶
            currentCategory: 'all',
            searchQuery: '',
            itemsPerPage: 9,
            currentPage: 1,
            isBatchMode: false,
            selectedIds: new Set()
        };

        // é˜² XSS æ³¨å…¥ï¼šHTML å®ä½“è½¬ä¹‰
        const escapeHTML = (str) => {
            if (str === null || str === undefined) return '';
            return String(str).replace(/[&<>'"]/g, 
                tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)
            );
        };

        // å…¨å±€æç¤ºæ¡†ç»„ä»¶
        const showToast = (message, type = 'info') => {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const bg = type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-slate-800 dark:bg-slate-700';
            toast.className = `px-4 py-2 rounded-full shadow-lg text-white text-sm font-medium ${bg} toast-enter flex items-center gap-2`;
            toast.innerHTML = message;
            container.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('toast-enter', 'toast-leave');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        };
        const initDB = () => new Promise((resolve, reject) => {
            const request = indexedDB.open(dbName, 1);
            request.onerror = () => { showToast('æ•°æ®åº“è¿æ¥å¤±è´¥', 'error'); reject('DB Error'); };
            request.onsuccess = (e) => { db = e.target.result; resolve(); };
            request.onupgradeneeded = (e) => {
                db = e.target.result;
                if (!db.objectStoreNames.contains('cards')) db.createObjectStore('cards', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('worldbooks')) db.createObjectStore('worldbooks', { keyPath: 'id' });
            };
        });

        // é‡æ„åçš„æ•°æ®åº“æ“ä½œå¯¹è±¡ï¼Œæ”¯æŒå†…å­˜å‹å¥½çš„è¯»å–å’Œæ‰¹é‡äº‹åŠ¡
        const dbOps = {
            // è·å–è½»é‡çº§å…ƒæ•°æ®åˆ—è¡¨ï¼ˆæ‹¦æˆªå¤§æ–‡ä»¶æ¸²æŸ“æˆ URLï¼Œæå¤§èŠ‚çœå†…å­˜ï¼‰
            getAllMeta: (storeName) => new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.openCursor();
                const results = [];

                request.onsuccess = (event) => {
                    const cursor = event.target.result;
                    if (cursor) {
                        const item = cursor.value;
                        // å‰¥ç¦»åºå¤§çš„ Base64/Blobï¼Œè½¬æ¢æˆå†…å­˜å‹å¥½çš„ URL ç”¨äºå±•ç¤ºå°é¢
                        results.push({
                            id: item.id,
                            name: item.name,
                            tags: item.tags,
                            note: item.note,
                            timestamp: item.timestamp,
                            hasImage: !!item.image,
                            hasRaw: !!item.rawFile,
                            hasCompanion: !!item.companionFile,
                            // å¦‚æœæ˜¯ Base64 å­—ç¬¦ä¸²å°±ç›´æ¥ç”¨ï¼Œå¦åˆ™è§†ä¸ºæ— å›¾ç‰‡
                            imageUrl: (item.image && typeof item.image === 'string') ? item.image : null
                        });
                        cursor.continue();
                    } else {
                        // æŒ‰æ—¶é—´æˆ³å€’åºæ’åˆ—
                        resolve(results.sort((a, b) => b.id - a.id));
                    }
                };
                request.onerror = () => reject('Failed to fetch data');
            }),

            // è·å–å•æ¡å®Œæ•´æ•°æ®ï¼ˆç”¨äºç¼–è¾‘æˆ–ä¸‹è½½æ—¶ä½¿ç”¨ï¼‰
            getCompleteItem: (storeName, id) => new Promise((resolve, reject) => {
                const request = db.transaction(storeName, 'readonly').objectStore(storeName).get(id);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject('Failed to fetch item');
            }),

            add: (storeName, item) => new Promise(resolve => { 
                const tx = db.transaction(storeName, 'readwrite'); 
                tx.objectStore(storeName).put(item); 
                tx.oncomplete = () => resolve(); 
            }),

            delete: (storeName, id) => new Promise(resolve => { 
                const tx = db.transaction(storeName, 'readwrite'); 
                tx.objectStore(storeName).delete(id); 
                tx.oncomplete = () => resolve(); 
            })
        };
        function initTheme() {
            try {
                const isDark = localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches);
                if (isDark) document.documentElement.classList.add('dark');
            } catch (e) { console.warn('æ— æ³•è®¿é—® localStorage'); }
            updateThemeIcons();
        }

        function toggleTheme() {
            const html = document.documentElement;
            try {
                if (html.classList.contains('dark')) {
                    html.classList.remove('dark'); localStorage.setItem('theme', 'light');
                } else {
                    html.classList.add('dark'); localStorage.setItem('theme', 'dark');
                }
            } catch (e) { html.classList.toggle('dark'); }
            updateThemeIcons();
        }

        function updateThemeIcons() {
            const isDark = document.documentElement.classList.contains('dark');
            const svg = isDark ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>';
            document.getElementById('themeIconM').innerHTML = svg;
            document.getElementById('themeIconPC').innerHTML = svg;
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar'), overlay = document.getElementById('sidebarOverlay');
            sb.classList.toggle('sidebar-closed'); overlay.classList.toggle('hide');
        }
        function switchTab(tab) {
            state.activeTab = tab; state.currentCategory = 'all'; state.currentPage = 1; state.isBatchMode = false; state.selectedIds.clear();
            
            document.getElementById('tab-cards-pc').className = tab === 'cards' ? 'px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all' : 'px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-all';
            document.getElementById('tab-wb-pc').className = tab === 'worldbooks' ? 'px-4 py-1.5 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white transition-all' : 'px-4 py-1.5 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400 hover:text-slate-700 dark:hover:text-white transition-all';
            document.getElementById('tab-cards-m').className = tab === 'cards' ? 'px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white' : 'px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400';
            document.getElementById('tab-wb-m').className = tab === 'worldbooks' ? 'px-3 py-1 text-sm font-medium rounded-md bg-white dark:bg-slate-600 shadow-sm text-indigo-600 dark:text-white' : 'px-3 py-1 text-sm font-medium rounded-md text-slate-500 dark:text-slate-400';
            
            document.getElementById('batchToggle').checked = false;
            toggleBatchMode(true); 
            updateView();
        }

        function toggleBatchMode(forceClose = false) {
            if (forceClose) state.isBatchMode = false;
            else state.isBatchMode = !state.isBatchMode;
            
            state.selectedIds.clear();
            const toggleUI = document.getElementById('batchToggleUI'), actionBar = document.getElementById('batchActionBar');
            const paginationEl = document.getElementById('paginationCtrl');
            
            if (state.isBatchMode) {
                toggleUI.classList.remove('bg-slate-300', 'dark:bg-slate-600'); toggleUI.classList.add('bg-indigo-500');
                toggleUI.firstElementChild.style.transform = 'translateX(100%)';
                actionBar.classList.remove('batch-bar-hidden');
                paginationEl.classList.add('bottom-24');
                paginationEl.classList.remove('bottom-6');
            } else {
                toggleUI.classList.add('bg-slate-300', 'dark:bg-slate-600'); toggleUI.classList.remove('bg-indigo-500');
                toggleUI.firstElementChild.style.transform = 'translateX(0)';
                actionBar.classList.add('batch-bar-hidden');
                paginationEl.classList.remove('bottom-24');
                paginationEl.classList.add('bottom-6');
            }
            updateView();
        }

        function updateView() {
            const currentData = state.data[state.activeTab] || [];
            const allTags = new Set();
            
            currentData.forEach(item => {
                if(item.tags && Array.isArray(item.tags)) item.tags.forEach(t => allTags.add(t));
            });
            const listEl = document.getElementById('categoryList');
            
            let html = `<button onclick="setCategory('all')" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${state.currentCategory === 'all' ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}">å…¨éƒ¨</button>`;
            Array.from(allTags).sort().forEach(tag => {
                const isActive = state.currentCategory === tag;
                const safeTag = escapeHTML(tag);
                html += `<button onclick="setCategory('${safeTag}')" class="px-3 py-1.5 rounded-full text-sm font-medium transition-colors ${isActive ? 'bg-indigo-600 text-white shadow-md' : 'bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700'}">${safeTag}</button>`;
            });
            listEl.innerHTML = html;

            let filtered = currentData;
            if (state.currentCategory !== 'all') filtered = filtered.filter(c => c.tags && c.tags.includes(state.currentCategory));
            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(c => (c.name && c.name.toLowerCase().includes(q)) || (c.tags && c.tags.join(' ').toLowerCase().includes(q)) || (c.note && c.note.toLowerCase().includes(q)));
            }
            document.getElementById('cardCount').textContent = `å…± ${filtered.length} æ¡è®°å½•`;

            const isShowAll = state.itemsPerPage === Infinity;
            const totalPages = isShowAll ? 1 : Math.ceil(filtered.length / state.itemsPerPage) || 1;
            
            if (state.currentPage > totalPages) state.currentPage = totalPages;
            if (state.currentPage < 1) state.currentPage = 1;
            
            document.getElementById('totalPages').textContent = totalPages;
            document.getElementById('pageInput').value = state.currentPage;
            
            const paginationEl = document.getElementById('paginationCtrl');
            if (isShowAll || filtered.length <= state.itemsPerPage) {
                paginationEl.classList.add('batch-bar-hidden');
            } else {
                paginationEl.classList.remove('batch-bar-hidden');
            }

            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            renderItems(isShowAll ? filtered : filtered.slice(startIndex, startIndex + state.itemsPerPage));
        }

        function setCategory(tag) { state.currentCategory = tag; state.currentPage = 1; updateView(); }
        function toggleViewMode() { state.itemsPerPage = document.getElementById('viewToggle').checked ? Infinity : 9; state.currentPage = 1; updateView(); }
        
        function changePage(delta) { 
            const isShowAll = state.itemsPerPage === Infinity;
            if (isShowAll) return;
            const currentData = state.data[state.activeTab] || [];
            let filtered = currentData;
            if (state.currentCategory !== 'all') filtered = filtered.filter(c => c.tags && c.tags.includes(state.currentCategory));
            if (state.searchQuery) {
                const q = state.searchQuery.toLowerCase();
                filtered = filtered.filter(c => (c.name && c.name.toLowerCase().includes(q)) || (c.tags && c.tags.join(' ').toLowerCase().includes(q)) || (c.note && c.note.toLowerCase().includes(q)));
            }
            const totalPages = Math.ceil(filtered.length / state.itemsPerPage) || 1;
            
            const newPage = state.currentPage + delta;
            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage; 
                updateView(); 
                window.scrollTo({ top: 0, behavior: 'smooth' }); 
            }
        }
        
        function jumpToPage() { const val = parseInt(document.getElementById('pageInput').value); if (!isNaN(val)) { state.currentPage = val; updateView(); window.scrollTo({ top: 0, behavior: 'smooth' }); } }
        function handleSearch(query) { state.searchQuery = query.trim(); state.currentPage = 1; updateView(); }
        function toggleSelection(id) {
            if (!state.isBatchMode) return;
            if (state.selectedIds.has(id)) state.selectedIds.delete(id);
            else state.selectedIds.add(id);
            document.getElementById('selectedCount').textContent = state.selectedIds.size;
            updateView();
        }
        function renderItems(items) {
            const grid = document.getElementById('cardGrid'); 
            grid.innerHTML = '';
            
            if (state.activeTab === 'worldbooks') {
                grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-5 mb-6';
            } else {
                grid.className = 'grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 sm:gap-5 mb-6';
            }
            
            if (items.length === 0) {
                document.getElementById('emptyState').classList.remove('hide');
                document.getElementById('emptyText').textContent = state.activeTab === 'cards' ? 'å¡ç‰‡åº“ä¸ºç©ºï¼Œè¯·æ·»åŠ ' : 'ä¸–ç•Œä¹¦åº“ä¸ºç©ºï¼Œè¯·æ·»åŠ ';
                return;
            }
            document.getElementById('emptyState').classList.add('hide');
            
            items.forEach(item => {
                const isSelected = state.selectedIds.has(item.id);
                const safeName = escapeHTML(item.name || 'æœªå‘½å');
                const safeNote = escapeHTML(item.note) || 'æš‚æ— å¤‡æ³¨';
                const tagsArray = Array.isArray(item.tags) ? item.tags : [];
                
                const tagsHtml = tagsArray.map(tag => {
                    const safeTag = escapeHTML(tag);
                    return `<span onclick="event.stopPropagation(); if(!state.isBatchMode) setCategory('${safeTag}')" class="bg-slate-100 dark:bg-slate-700 text-indigo-600 dark:text-indigo-400 px-2 py-0.5 rounded text-[10px] font-medium ${state.isBatchMode ? '' : 'cursor-pointer hover:bg-indigo-100 dark:hover:bg-slate-600'}">${safeTag}</span>`;
                }).join('');
                const fileBadge = item.hasRaw ? `<div class="bg-emerald-100 dark:bg-emerald-900/50 text-emerald-700 dark:text-emerald-300 text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1">Raw File</div>` : '';
                const compBadge = item.hasCompanion ? `<div class="bg-amber-100 dark:bg-amber-900/50 text-amber-700 dark:text-amber-300 text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1">Companion</div>` : '';
                
                const el = document.createElement('div');
                el.onclick = () => toggleSelection(item.id);

                if (state.activeTab === 'worldbooks') {
                    el.className = `bg-white dark:bg-slate-800 rounded-2xl shadow-sm overflow-hidden transition-all duration-300 group flex items-start gap-4 p-4 ${state.isBatchMode ? 'card-selectable' : 'hover:shadow-md'} ${isSelected ? 'card-selected' : 'border border-slate-200/60 dark:border-slate-700'}`;
                    const imgLogic = item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full object-cover">` : `<span class="text-2xl opacity-50">ğŸ“–</span>`;
                    const clickImageLogic = (item.imageUrl && !state.isBatchMode) ? `onclick="event.stopPropagation(); openLightbox('${item.imageUrl}');" class="cursor-zoom-in"` : '';
                    
                    el.innerHTML = `
                        <div class="w-20 h-20 rounded-xl shrink-0 overflow-hidden bg-slate-100 dark:bg-slate-900 flex items-center justify-center relative" ${clickImageLogic}>
                            ${imgLogic}
                            ${isSelected ? '<div class="absolute inset-0 bg-indigo-600/30 flex items-center justify-center"><div class="bg-indigo-600 text-white rounded-full p-1"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div></div>' : ''}
                        </div>
                        <div class="flex flex-col flex-grow min-w-0">
                            <h3 class="font-bold text-slate-800 dark:text-slate-200 text-base mb-1 truncate">${safeName}</h3>
                            <div class="flex flex-wrap gap-1 mb-1.5">${tagsHtml}</div>
                            <div class="flex gap-1.5 mb-2">${fileBadge}${compBadge}</div>
                            <div class="flex justify-between items-center mt-auto ${state.isBatchMode ? 'opacity-50 pointer-events-none' : ''}">
                                <div class="flex gap-1 -ml-2">
                                    <button onclick="event.stopPropagation(); openDownloadModal('${item.id}')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 hover:bg-indigo-50 dark:hover:bg-slate-700 px-2 py-1 rounded text-xs font-semibold transition-colors">ä¸‹è½½</button>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="event.stopPropagation(); editItem('${item.id}')" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 px-2 py-1 rounded text-xs font-semibold transition-colors">ç¼–è¾‘</button>
                                    <button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-slate-700 px-2 py-1 -mr-2 rounded text-xs font-semibold transition-colors">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    el.className = `bg-white dark:bg-slate-800 rounded-2xl shadow-sm overflow-hidden transition-all duration-300 group flex flex-col ${state.isBatchMode ? 'card-selectable' : 'hover:shadow-lg'} ${isSelected ? 'card-selected' : 'border border-slate-200/60 dark:border-slate-700'}`;
                    const fileBadgeTop = item.hasRaw ? `<div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-full flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path></svg> Raw</div>` : '';
                    const compBadgeTop = item.hasCompanion ? `<div class="absolute top-2 left-2 bg-amber-500/80 backdrop-blur-sm text-white text-[10px] px-2 py-1 rounded-full flex items-center gap-1">Comp</div>` : '';
                    const imageHtml = item.imageUrl ? `<img src="${item.imageUrl}" loading="lazy" class="w-full h-full object-cover object-top ${state.isBatchMode ? '' : 'group-hover:scale-105'} transition-transform duration-500">` : `<div class="w-full h-full flex items-center justify-center bg-slate-200/50 dark:bg-slate-700/50 text-5xl">ğŸ–¼ï¸</div>`;
                    const clickImageLogic = (item.imageUrl && !state.isBatchMode) ? `onclick="event.stopPropagation(); openLightbox('${item.imageUrl}');"` : '';
                    const cursorLogic = (item.imageUrl && !state.isBatchMode) ? 'cursor-zoom-in' : '';

                    el.innerHTML = `
                        <div class="relative w-full aspect-[2/3] overflow-hidden bg-slate-100 dark:bg-slate-900 ${cursorLogic}" ${clickImageLogic}>
                            ${imageHtml}${fileBadgeTop}${compBadgeTop}
                            ${isSelected ? '<div class="absolute inset-0 bg-indigo-600/30 flex items-center justify-center"><div class="bg-indigo-600 text-white rounded-full p-1"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div></div>' : ''}
                        </div>
                        <div class="p-3.5 flex flex-col flex-grow">
                            <h3 class="font-bold text-slate-800 dark:text-slate-200 text-base mb-1.5 line-clamp-1">${safeName}</h3>
                            <div class="flex flex-wrap gap-1 mb-2">${tagsHtml}</div>
                            <p class="text-xs text-slate-500 dark:text-slate-400 line-clamp-2 flex-grow mb-3 leading-relaxed">${safeNote}</p>
                            <div class="flex justify-between items-center pt-2 border-t border-slate-100 dark:border-slate-700 ${state.isBatchMode ? 'opacity-50 pointer-events-none' : ''}">
                                <div class="flex gap-1 -ml-2">
                                    <button onclick="event.stopPropagation(); openDownloadModal('${item.id}')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 hover:bg-indigo-50 dark:hover:bg-slate-700 px-2 py-1 rounded text-xs font-semibold transition-colors">ä¸‹è½½</button>
                                </div>
                                <div class="flex gap-1">
                                    <button onclick="event.stopPropagation(); editItem('${item.id}')" class="text-slate-500 hover:bg-slate-100 dark:hover:bg-slate-700 px-2 py-1 rounded text-xs font-semibold transition-colors">ç¼–è¾‘</button>
                                    <button onclick="event.stopPropagation(); deleteItem('${item.id}')" class="text-red-400 hover:text-red-600 hover:bg-red-50 dark:hover:bg-slate-700 px-2 py-1 -mr-2 rounded text-xs font-semibold transition-colors">åˆ é™¤</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
                grid.appendChild(el);
            });
        }
function openLightbox(src) { document.getElementById('lightboxImg').src = src; document.getElementById('lightbox').classList.remove('hide'); setTimeout(()=>document.getElementById('lightboxImg').classList.remove('scale-95'), 10); }
        function closeLightbox() { document.getElementById('lightboxImg').classList.add('scale-95'); setTimeout(()=>document.getElementById('lightbox').classList.add('hide'), 300); }
        
        function closeModal(modalId, contentId) { 
            toggleModal(modalId, contentId, true); 
            if(modalId === 'uploadModal') setTimeout(()=>document.getElementById('uploadForm').reset(), 300); 
        }
        
        function toggleModal(modalId, contentId, forceClose=false) {
            const m = document.getElementById(modalId), c = document.getElementById(contentId);
            if (forceClose || !m.classList.contains('hide')) { 
                m.classList.add('opacity-0'); c.classList.add('scale-95'); 
                setTimeout(() => m.classList.add('hide'), 300); 
            } else { 
                m.classList.remove('hide'); void m.offsetWidth; 
                m.classList.remove('opacity-0'); c.classList.remove('scale-95'); 
            }
        }

        function markDeleteFile(type) {
            document.getElementById(`flagDelete${type}`).value = 'true';
            document.getElementById(`existing${type}UI`).classList.add('hidden');
            if (type === 'Image' && state.activeTab === 'cards') {
                document.getElementById('imageInput').required = true;
                document.getElementById('imgRequired').textContent = '(å¿…å¡«)';
            }
        }

        const fileToBase64 = (file) => new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file); });

        function openUploadModal() {
            document.getElementById('uploadForm').reset();
            document.getElementById('editItemId').value = '';
            document.getElementById('modalTitle').textContent = state.activeTab === 'cards' ? 'æ–°å¢è§’è‰²å¡' : 'æ–°å¢ä¸–ç•Œä¹¦';
            
            ['Image', 'Raw', 'Companion'].forEach(type => {
                document.getElementById(`flagDelete${type}`).value = 'false';
                document.getElementById(`existing${type}UI`).classList.add('hidden');
                document.getElementById(`existing${type}UI`).classList.remove('flex');
            });
            
            document.getElementById('imageInput').required = state.activeTab === 'cards';
            document.getElementById('imgRequired').textContent = state.activeTab === 'cards' ? '(å¿…å¡«)' : '(å¯é€‰)';
            
            toggleModal('uploadModal', 'modalContent');
        }

        // å¼‚æ­¥è·å–å®Œæ•´æ•°æ®è¿›è¡Œç¼–è¾‘
        async function editItem(id) {
            // æ³¨æ„è¿™é‡Œï¼šä»æ•°æ®åº“ä¸­æå–å®Œæ•´æ–‡ä»¶ç”¨äºç¼–è¾‘çŠ¶æ€åˆ¤å®š
            const item = await dbOps.getCompleteItem(state.activeTab, Number(id));
            if (!item) return;
            
            document.getElementById('editItemId').value = item.id;
            document.getElementById('nameInput').value = item.name;
            document.getElementById('tagsInput').value = item.tags ? item.tags.join(', ') : '';
            document.getElementById('noteInput').value = item.note || '';
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘è®°å½•';
            
            ['Image', 'Raw', 'Companion'].forEach(type => {
                document.getElementById(`flagDelete${type}`).value = 'false';
                document.getElementById(`existing${type}UI`).classList.add('hidden');
                document.getElementById(`existing${type}UI`).classList.remove('flex');
            });
            
            if (item.image) {
                document.getElementById('existingImageUI').classList.remove('hidden');
                document.getElementById('existingImageUI').classList.add('flex');
                document.getElementById('imageInput').required = false;
            } else {
                document.getElementById('imageInput').required = state.activeTab === 'cards';
            }
            
            if (item.rawFile) {
                document.getElementById('existingRawUI').classList.remove('hidden');
                document.getElementById('existingRawUI').classList.add('flex');
                document.getElementById('existingRawName').textContent = escapeHTML(item.rawFileName) || 'å·²åŒ…å«æ–‡ä»¶';
            }
            
            if (item.companionFile) {
                document.getElementById('existingCompanionUI').classList.remove('hidden');
                document.getElementById('existingCompanionUI').classList.add('flex');
                document.getElementById('existingCompanionName').textContent = escapeHTML(item.companionFileName) || 'å·²åŒ…å«æ–‡ä»¶';
            }
            
            toggleModal('uploadModal', 'modalContent');
        }

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('editItemId').value;
            const name = document.getElementById('nameInput').value.trim();
            const tags = document.getElementById('tagsInput').value.split(',').map(t => t.trim()).filter(t => t);
            const note = document.getElementById('noteInput').value.trim();
            
            const imageFile = document.getElementById('imageInput').files[0];
            const rawFile = document.getElementById('rawFileInput').files[0];
            const compFile = document.getElementById('companionFileInput').files[0];
            
            const isEdit = !!id;
            let existingItem = null;
            if (isEdit) {
                // ä¿®å¤ bugï¼šç”¨ Number ä¿è¯åŸå°ä¸åŠ¨è¯»å– IDï¼ˆé˜²æ­¢æµ®ç‚¹æ•°è¢«è§£ææˆæ•´æ•°ï¼‰
                existingItem = await dbOps.getCompleteItem(state.activeTab, Number(id));
            }
            
            let imageData = existingItem ? existingItem.image : null;
            if (imageFile) imageData = await fileToBase64(imageFile);
            else if (document.getElementById('flagDeleteImage').value === 'true') imageData = null;
            
            let rawData = existingItem ? existingItem.rawFile : null;
            let rawName = existingItem ? existingItem.rawFileName : null;
            if (rawFile) {
                rawData = await fileToBase64(rawFile);
                rawName = rawFile.name;
            } else if (document.getElementById('flagDeleteRaw').value === 'true') {
                rawData = null;
                rawName = null;
            }
            
            let compData = existingItem ? existingItem.companionFile : null;
            let compName = existingItem ? existingItem.companionFileName : null;
            if (compFile) {
                compData = await fileToBase64(compFile);
                compName = compFile.name;
            } else if (document.getElementById('flagDeleteCompanion').value === 'true') {
                compData = null;
                compName = null;
            }
            
            const newItem = {
                // å½»åº•ä¿®å¤ï¼šä½¿ç”¨ Number é˜²æ­¢å¯¼å…¥æ•°æ®çš„ç‰¹æ®Š ID è¢«æˆªæ–­
                id: isEdit ? Number(id) : Date.now(),
                name,
                tags,
                note,
                image: imageData,
                rawFile: rawData,
                rawFileName: rawName,
                companionFile: compData,
                companionFileName: compName,
                timestamp: isEdit && existingItem ? existingItem.timestamp : Date.now()
            };
            
            await dbOps.add(state.activeTab, newItem);
            // ä¿å­˜åé‡æ–°è¯»å–è½»é‡çº§å…ƒæ•°æ®
            state.data[state.activeTab] = await dbOps.getAllMeta(state.activeTab);
            
            closeModal('uploadModal', 'modalContent');
            updateView();
            showToast(isEdit ? 'è®°å½•å·²æ›´æ–°' : 'å·²æ·»åŠ æ–°è®°å½•', 'success');
        });        async function openDownloadModal(target) {
            document.getElementById('dlTargetId').value = target;
            const container = document.getElementById('downloadOptions');
            container.innerHTML = '';
            
            let hasImage = false, hasRaw = false, hasComp = false;

            if (target === 'batch') {
                const ids = Array.from(state.selectedIds);
                // å³ä½¿æ˜¯æ‰¹é‡ä¹Ÿå…ˆä»è½»é‡ metadata ä¸­åˆ¤æ–­æ–‡ä»¶å­˜åœ¨æ€§
                ids.forEach(id => {
                    const item = state.data[state.activeTab].find(i => i.id == id);
                    if (item) {
                        if (item.hasImage) hasImage = true;
                        if (item.hasRaw) hasRaw = true;
                        if (item.hasCompanion) hasComp = true;
                    }
                });
            } else {
                const item = state.data[state.activeTab].find(i => i.id == target);
                if (item) {
                    if (item.hasImage) hasImage = true;
                    if (item.hasRaw) hasRaw = true;
                    if (item.hasCompanion) hasComp = true;
                }
            }

            if(hasImage) container.innerHTML += `<label class="flex items-center gap-3 cursor-pointer p-2.5 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl border border-slate-100 dark:border-slate-600 transition-colors"><input type="checkbox" id="cbDlImage" class="w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 bg-white" checked><span class="text-slate-700 dark:text-slate-300 text-sm font-medium">å°é¢ / è§’è‰²å›¾ (Cover)</span></label>`;
            if(hasRaw) container.innerHTML += `<label class="flex items-center gap-3 cursor-pointer p-2.5 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl border border-slate-100 dark:border-slate-600 transition-colors"><input type="checkbox" id="cbDlRaw" class="w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 bg-white" checked><span class="text-slate-700 dark:text-slate-300 text-sm font-medium">æºæ–‡ä»¶ (Raw File)</span></label>`;
            if(hasComp) container.innerHTML += `<label class="flex items-center gap-3 cursor-pointer p-2.5 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-xl border border-slate-100 dark:border-slate-600 transition-colors"><input type="checkbox" id="cbDlCompanion" class="w-4 h-4 text-indigo-600 rounded border-slate-300 focus:ring-indigo-500 bg-white" checked><span class="text-slate-700 dark:text-slate-300 text-sm font-medium">é™„åŠ æ–‡ä»¶ (Companion)</span></label>`;

            if(!hasImage && !hasRaw && !hasComp) {
                container.innerHTML = '<div class="text-center py-4 text-slate-500 dark:text-slate-400 text-sm">è¯¥è®°å½•æœªåŒ…å«ä»»ä½•å¯ä¸‹è½½æ–‡ä»¶</div>';
            }

            toggleModal('downloadModal', 'downloadModalContent');
        }

        function triggerDownload(url, filename) {
            const a = document.createElement('a'); a.href = url; a.download = filename; 
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
        }

        // å»¶é•¿äº†å»¶è¿Ÿç­‰å¾…æ—¶é—´ï¼Œç•™å‡ºæµè§ˆå™¨å®‰å…¨ç­–ç•¥å¤„ç†çš„æ—¶é—´
        const delayWait = (ms) => new Promise(res => setTimeout(res, ms));

        async function executeDownload() {
            const target = document.getElementById('dlTargetId').value;
            const cbImg = document.getElementById('cbDlImage');
            const cbRaw = document.getElementById('cbDlRaw');
            const cbComp = document.getElementById('cbDlCompanion');
            
            const dlImage = cbImg ? cbImg.checked : false;
            const dlRaw = cbRaw ? cbRaw.checked : false;
            const dlComp = cbComp ? cbComp.checked : false;

            if(!dlImage && !dlRaw && !dlComp) {
                closeModal('downloadModal', 'downloadModalContent');
                return showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹è¿›è¡Œä¸‹è½½', 'error');
            }

            closeModal('downloadModal', 'downloadModalContent');

            if (target === 'batch') {
                showToast(`å¼€å§‹æ’é˜Ÿä¸‹è½½ï¼Œç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œè¯·è€å¿ƒç­‰å¾…...`, 'info');
                const ids = Array.from(state.selectedIds);
                
                for (let id of ids) {
                    // éœ€è¦æ‹‰å–åŒ…å«æ–‡ä»¶çš„å®Œæ•´æ•°æ®æ¥æ‰§è¡Œä¸‹è½½
                    const item = await dbOps.getCompleteItem(state.activeTab, id);
                    if (!item) continue;
                    
                    if (dlImage && item.image) { 
                        triggerDownload(item.image, `${item.name}_Cover.png`); 
                        await delayWait(1200); 
                    }
                    if (dlRaw && item.rawFile) { 
                        triggerDownload(item.rawFile, item.rawFileName || `${item.name}_RawFile`); 
                        await delayWait(1200); 
                    }
                    if (dlComp && item.companionFile) { 
                        triggerDownload(item.companionFile, item.companionFileName || `${item.name}_Companion`); 
                        await delayWait(1200); 
                    }
                }
                
                showToast(`æ‰€é€‰æ–‡ä»¶æ‰¹é‡ä¸‹è½½è¯·æ±‚å‘é€å®Œæ¯•`, 'success');
                setTimeout(() => toggleBatchMode(true), 1000);
            } else {
                const item = await dbOps.getCompleteItem(state.activeTab, Number(target));
                if (!item) return;
                
                if (dlImage && item.image) { triggerDownload(item.image, `${item.name}_Cover.png`); await delayWait(800); }
                if (dlRaw && item.rawFile) { triggerDownload(item.rawFile, item.rawFileName || `${item.name}_RawFile`); await delayWait(800); }
                if (dlComp && item.companionFile) { triggerDownload(item.companionFile, item.companionFileName || `${item.name}_Companion`); }
                
                showToast('å·²è¯·æ±‚ä¸‹è½½', 'success');
            }
        }
        async function deleteItem(id) { 
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ•°æ®ä¸å¯æ¢å¤ã€‚')) { 
                await dbOps.delete(state.activeTab, Number(id)); 
                state.data[state.activeTab] = await dbOps.getAllMeta(state.activeTab); 
                updateView(); 
                showToast('å·²åˆ é™¤', 'success'); 
            } 
        }
        
        function batchDeletePrompt() { 
            if(state.selectedIds.size === 0) return showToast('æœªé€‰æ‹©ä»»ä½•é¡¹ç›®', 'error'); 
            if(confirm(`ç¡®å®šè¦æ°¸ä¹…åˆ é™¤è¿™ ${state.selectedIds.size} é¡¹æ•°æ®å—ï¼Ÿ`)) batchDelete(); 
        }
        
        async function batchDelete() { 
            for (let id of state.selectedIds) { await dbOps.delete(state.activeTab, id); } 
            state.data[state.activeTab] = await dbOps.getAllMeta(state.activeTab); 
            toggleBatchMode(true); 
            updateView(); 
            showToast('æ‰¹é‡åˆ é™¤å®Œæˆ', 'success'); 
        }

        async function exportData() { 
            showToast('å‡†å¤‡æ‰“åŒ…æ•°æ®ï¼Œè¿™å¯èƒ½éœ€è¦ä¸€ç‚¹æ—¶é—´...', 'info');
            try { 
                // å¯¼å‡ºéœ€è¦å…¨é‡æ•°æ®ï¼ˆä½¿ç”¨æœ€åŸå§‹çš„ getAllï¼‰
                const getRawAll = (store) => new Promise(res => { const req = db.transaction(store, 'readonly').objectStore(store).getAll(); req.onsuccess = () => res(req.result); });
                const cards = await getRawAll('cards'); 
                const worldbooks = await getRawAll('worldbooks'); 
                const dataStr = JSON.stringify({ cards, worldbooks }); 
                const blob = new Blob([dataStr], { type: 'application/json' }); 
                const a = document.createElement('a'); 
                a.href = URL.createObjectURL(blob); 
                document.body.appendChild(a); 
                a.download = `TavernData_Backup_${new Date().toLocaleDateString().replace(/\//g,'-')}.json`; 
                a.click(); 
                document.body.removeChild(a); 
                showToast('å¤‡ä»½å¯¼å‡ºæˆåŠŸ', 'success'); 
            } catch(e) { 
                showToast('æ•°æ®è¿‡å¤§å¯¼å‡ºå¤±è´¥ï¼Œå»ºè®®åˆ†æ‰¹å¤„ç†', 'error'); 
            } 
        }
        
        function importData(e) { 
            const file = e.target.files[0]; 
            if(!file) return; 
            if(!confirm('å¯¼å…¥å°†ä¼šè¿½åŠ æ•°æ®ï¼Œå¦‚é‡ç›¸åŒ ID çš„æ—§æ•°æ®å¯èƒ½ä¼šè¢«è¦†ç›–ã€‚ç¡®å®šç»§ç»­å—ï¼Ÿ')) {
                e.target.value = '';
                return;
            }
            showToast('æ­£åœ¨è¯»å–å’Œå¯¼å…¥æ•°æ®...', 'info');
            const reader = new FileReader(); 
            reader.onload = async (ev) => { 
                try { 
                    const data = JSON.parse(ev.target.result); 
                    
                    const validateItem = (item) => {
                        return {
                            ...item,
                            id: item.id || Date.now() + Math.random(),
                            name: item.name || 'å¯¼å…¥çš„æœªå‘½åé¡¹ç›®',
                            tags: Array.isArray(item.tags) ? item.tags : []
                        };
                    };

                    // ä¼˜åŒ–ï¼šä½¿ç”¨åŒä¸€äº‹åŠ¡æ‰¹é‡å¯¼å…¥
                    const tx = db.transaction(['cards', 'worldbooks'], 'readwrite');
                    
                    if(data.cards && Array.isArray(data.cards)) {
                        const store = tx.objectStore('cards');
                        data.cards.forEach(c => store.put(validateItem(c)));
                    }
                    if(data.worldbooks && Array.isArray(data.worldbooks)) {
                        const store = tx.objectStore('worldbooks');
                        data.worldbooks.forEach(w => store.put(validateItem(w)));
                    }
                    
                    tx.oncomplete = async () => {
                        state.data.cards = await dbOps.getAllMeta('cards'); 
                        state.data.worldbooks = await dbOps.getAllMeta('worldbooks'); 
                        updateView(); 
                        showToast('æ•°æ®æ¢å¤æˆåŠŸ', 'success'); 
                    };
                    tx.onerror = () => { throw new Error("Transaction Failed") };
                    
                } catch(err) { 
                    console.error(err);
                    showToast('æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®æˆ–å¯¼å…¥å¤±è´¥', 'error'); 
                } finally {
                    e.target.value = '';
                }
            }; 
            reader.readAsText(file); 
        }

        window.onload = async () => {
            initTheme();
            try {
                await initDB();
                // å¯åŠ¨æ—¶ä»…åŠ è½½è½»é‡çº§å…ƒæ•°æ®
                state.data.cards = await dbOps.getAllMeta('cards');
                state.data.worldbooks = await dbOps.getAllMeta('worldbooks');
                updateView();
                // ç§»é™¤åŸæœ‰çš„ success toastï¼Œä¿æŒç•Œé¢æ¸…çˆ½
            } catch (e) { 
                console.error(e); 
            }
        };
    </script>
</html>
